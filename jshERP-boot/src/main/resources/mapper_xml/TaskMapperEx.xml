<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jsh.erp.datasource.mappers.TaskMapperEx">
    <resultMap extends="com.jsh.erp.datasource.mappers.TaskMapper.BaseResultMap" id="ResultMapEx" type="com.jsh.erp.datasource.entities.TaskEx">
        <result column="creatorName" jdbcType="VARCHAR" property="creatorName" />
        <association property="material" javaType="java.lang.Long" column="material"
                     select="com.jsh.erp.datasource.mappers.MaterialMapper.selectByPrimaryKey">
        </association>
    </resultMap>

    <select id="selectByConditionTask" parameterType="com.jsh.erp.datasource.entities.TaskEx" resultMap="ResultMapEx">
        select ta.*,usr.username as creatorName
        FROM task ta
        left join jsh_user usr on usr.id=ta.creator and ifnull(usr.status,'0') not in('1','2')
        where 1=1
        <if test="planBeginTime != null and planEndTime != null">
            and plan_over_time between #{planBeginTime} and #{planEndTime}
        </if>
        <if test="beginTime != null and endTime != null">
            and over_time between #{beginTime} and #{endTime}
        </if>
        <if test="taskEx.remark != null">
            <bind name="bindRemark" value="'%'+taskEx.remark+'%'"/>
            and ta.remark like #{bindRemark}
        </if>
        order by create_time
        <if test="offset != null and rows != null">
            limit #{offset},#{rows}
        </if>
    </select>


    <select id="countsByTask" resultType="java.lang.Long">
        SELECT
        COUNT(ta.id)
        FROM task ta
        left join jsh_user usr on usr.id=ta.creator and ifnull(usr.status,'0') not in('1','2')
        where 1=1
        <if test="planBeginTime != null and planEndTime != null">
            and plan_over_time between #{planBeginTime} and #{planEndTime}
        </if>
        <if test="beginTime != null and endTime != null">
            and over_time between #{beginTime} and #{endTime}
        </if>
        <if test="taskEx.remark != null">
            <bind name="bindRemark" value="'%'+taskEx.remark+'%'"/>
            and ta.remark like #{bindRemark}
        </if>
    </select>
</mapper>
